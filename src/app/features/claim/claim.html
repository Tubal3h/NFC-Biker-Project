<div class="claim-container">

  <!-- ====================================================== -->
  <!-- STATI INIZIALI: CARICAMENTO E TAG NON TROVATO -->
  <!-- ====================================================== -->

  <!-- Mostrato mentre l'API verifica lo stato del tag -->
  <div *ngIf="step === 'checking'" class="loading-state">Verifica del tag NFC in corso...</div>

  <!-- Mostrato se l'API dice che il tag non è valido o non esiste -->
  <div *ngIf="step === 'notfound'" class="text-danger">
    Questo tag NFC non è valido o non è stato generato dal nostro sistema.
  </div>

  
  <!-- ====================================================== -->
  <!-- STEP PRINCIPALE: IL TAG È VALIDO E PUÒ ESSERE ASSOCIATO -->
  <!-- ====================================================== -->

  <!-- Usiamo *ngIf="step === 'ok' ..." per mostrare questo blocco solo quando il tag è valido -->
  <div *ngIf="step === 'ok'">
    
    <!-- Sotto-sezione 1: Mostrata se l'utente NON è loggato -->
    <!-- `!(user$ | async)` è il modo corretto per verificare se l'utente è null -->
    <div *ngIf="!(user$ | async)">
      <div class="container">
        <h2>Benvenuto! Collega il tuo casco digitale</h2>
        <div class="subtitle">
          Per associare questo casco al tuo profilo, effettua l’accesso o crea un nuovo account gratuito.
        </div>
        <div class="auth-tabs">
          <!-- Usiamo [queryParams] per passare l'ID del tag alle pagine di login/register, così possiamo tornarci dopo -->
          <a class="auth-button" [routerLink]="['/login']" [queryParams]="{ nfcId: nfcId }">Login</a>
          <a class="auth-button" [routerLink]="['/register']" [queryParams]="{ nfcId: nfcId }">Registrati</a>
        </div>
        <div class="info-box">
          <b>Perché serve un account?</b>
          <ul>
            <li>Personalizzi la scheda sanitaria collegata al casco.</li>
            <li>Aggiungi, modifichi o rimuovi i tuoi dispositivi.</li>
            <li>I tuoi dati restano sicuri e disponibili solo a te.</li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Sotto-sezione 2: Mostrata se l'utente È loggato -->
    <!-- `(user$ | async) as user` mette l'oggetto utente in una variabile locale `user` -->
    <div *ngIf="(user$ | async) as user" class="claim-form">
      <h3>Sei quasi alla fine!</h3>
      <p>
        Stai per associare questo adesivo NFC al tuo account:<br>
        <b>{{ user.name || user.email }}</b>
      </p>
      <button type="button" (click)="claimAuto()">Conferma e Associa Casco</button>
      <button class="logout-btn" (click)="logout()" type="button">Esci (non sei tu?)</button>
      
      <!-- Mostra un eventuale messaggio di risultato/errore -->
      <div *ngIf="claimResult" class="mt-2">{{ claimResult }}</div>
    </div>

  </div>

</div>