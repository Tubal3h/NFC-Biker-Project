@if (showPrivacyPopup) {
  <div class="privacy-popup-backdrop">
    <div class="privacy-popup">
      <h3><fa-icon [icon]="faExclamationTriangle"></fa-icon> Accesso Riservato</h3>
        <p>
          Stai per accedere a dati sanitari personali e sensibili, protetti dal <b>Regolamento GDPR</b>.
          L'accesso a queste informazioni è consentito <b>esclusivamente per finalità di primo soccorso in caso di emergenza</b>.
        </p>
      <div class="info-box">
        <b>IP rilevato:</b> {{ visitorIp || 'Rilevamento...' }}<br>
        <b>Posizione:</b> {{ visitorLocation || 'Rilevamento...' }}
      </div>
      <div class="popup-actions">
        <button (click)="cancelAndGoBack()" class="btn-cancel">Annulla</button>
        <button (click)="acceptPrivacy()" class="btn-access">Accetto e Accedi</button>
      </div>
    </div>
  </div>
}

@if (!showPrivacyPopup) {
  <div class="scheda-container">

    @if (isLoading) {
      <div class="scheda-state">
        <div class="spinner"></div>
        Caricamento in corso...
      </div>
    }

    @if (!isLoading && errorMsg && !isCardEmpty) {
      <div class="scheda-state">
        <div class="icon-error">!</div>
        <div class="alert">{{ errorMsg }}</div>
      </div>
    }

    @if (!isLoading && isCardEmpty) {
      <div class="scheda-state">
        <div class="icon-error">!</div>
        <div class="alert">Scheda medica non compilata.</div>
        <div>
          @if (auth.isLogged && isOwner) {
            <button class="btn-action" (click)="goToDashboard()">
              Vai alla Dashboard per Compilare
            </button>
          } @else if (!auth.isLogged) {
            <button class="btn-action" (click)="goToLogin()">
              Fai il Login per Compilare
            </button>
          }
        </div>
      </div>
    }

    @if (!isLoading && !errorMsg && !isCardEmpty && medicalData && user) {
      <div class="scheda-wrapper">
        
        <div class="warning-banner">
          <div class="warning-icon"><fa-icon [icon]="faExclamationTriangle"></fa-icon></div>
          <div class="warning-text">
            <b>Accesso Riservato:</b> Stai visualizzando dati sanitari sensibili. L'utilizzo è consentito solo in caso di reale emergenza.
          </div>
        </div>

        <div class="scheda-header">
          <fa-icon [icon]="faIdCard" class="icon-header"></fa-icon>
          <h2>Scheda Sanitaria</h2>
        </div>

        <div class="info-item">
          <div class="icon"><fa-icon [icon]="faUser"></fa-icon></div>
          <div class="text">
            <div class="label">Nome e Cognome</div>
            <div class="value">{{ medicalData.name }} {{ medicalData.surname }}</div>
          </div>
        </div>
        
        @if (medicalData.birthDate) {
          <div class="info-item">
            <div class="icon"><fa-icon [icon]="faBirthdayCake"></fa-icon></div>
            <div class="text">
              <div class="label">Data di Nascita</div>
              <div class="value">{{ medicalData.birthDate | date:'dd/MM/yyyy' }}</div>
            </div>
          </div>
        }

        @if (medicalData.birthPlace) {
          <div class="info-item">
            <div class="icon"><fa-icon [icon]="faMapMarkerAlt"></fa-icon></div>
            <div class="text">
              <div class="label">Luogo di Nascita</div>
              <div class="value">{{ medicalData.birthPlace }}</div>
            </div>
          </div>
        }

        @if (medicalData.residence) {
          <div class="info-item">
            <div class="icon"><fa-icon [icon]="faHome"></fa-icon></div>
            <div class="text">
              <div class="label">Residenza</div>
              <div class="value">{{ medicalData.residence }}</div>
            </div>
          </div>
        }
        
        <div class="info-item info-item--critical">
          <div class="icon"><fa-icon [icon]="faTint"></fa-icon></div>
          <div class="text">
            <div class="label">Gruppo Sanguigno</div>
            <div class="value">{{ medicalData.bloodType || 'Non specificato' }}</div>
          </div>
        </div>
        
        <div class="info-item info-item--critical">
          <div class="icon"><fa-icon [icon]="faAllergies"></fa-icon></div>
          <div class="text">
            <div class="label">Allergie</div>
            <div class="value">{{ medicalData.allergies || 'Nessuna' }}</div>
          </div>
        </div>
        
        <div class="info-item">
          <div class="icon"><fa-icon [icon]="faNotesMedical"></fa-icon></div>
          <div class="text">
            <div class="label">Patologie Rilevanti</div>
            <div class="value">{{ medicalData.conditions || 'Nessuna' }}</div>
          </div>
        </div>
        
        <div class="info-item">
          <div class="icon"><fa-icon [icon]="faStickyNote"></fa-icon></div>
          <div class="text">
            <div class="label">Note Aggiuntive</div>
            <div class="value">{{ medicalData.notes || 'Nessuna' }}</div>
          </div>
        </div>
        
        @if (medicalData.emergencyContacts && medicalData.emergencyContacts.length > 0) {
          <div class="info-item">
            <div class="icon"><fa-icon [icon]="faAddressBook"></fa-icon></div>
            <div class="text">
              <div class="label">Contatti d'Emergenza</div>
              <ul class="contacts-list">
                @for (c of medicalData.emergencyContacts; track c.phone) {
                  <li>
                    <div class="contact-info">
                      <b>{{ c.name }}</b> ({{ c.relation }})
                    </div>
                    <a class="phone-link" [href]="'tel:' + c.phone">
                      <fa-icon [icon]="faPhoneAlt"></fa-icon>
                      Chiama {{ c.phone }}
                    </a>
                  </li>
                }
              </ul>
            </div>
          </div>
        }
      </div>

      @if (isOwner && auth.user?.premium && availableProfiles.length > 1) {
        <div class="profile-switcher">
          <h4><fa-icon [icon]="faSyncAlt"></fa-icon> Cambia Profilo Associato</h4>
          <p>Questo casco sta mostrando il profilo medico di <strong>{{ medicalData?.profileName }}</strong>. Puoi cambiarlo con un altro dei tuoi profili.</p>
          <div class="switcher-form">
            <select [(ngModel)]="selectedProfileId">
              @for (profile of availableProfiles; track profile.id) {
                <option [value]="profile.id">{{ profile.profileName }}</option>
              }
            </select>
            <button (click)="onProfileSwitch()" [disabled]="isSwitching">
              {{ isSwitching ? 'Salvo...' : 'Salva' }}
            </button>
          </div>
        </div>
      }
    }
  </div>
}