<div class="form-container">

  <!-- Mostra un messaggio di caricamento mentre i dati vengono recuperati dal backend -->
  <div *ngIf="isLoading" class="loading-indicator">
    Caricamento dati in corso...
  </div>

  <!-- Mostra il form solo quando il caricamento è completato -->
  <div *ngIf="!isLoading">

    <div class="form-header">
      <a routerLink="/dashboard" class="back-link"><i class="fas fa-arrow-left"></i> Torna alla Dashboard</a>
      <h1>La Tua Scheda Medica</h1>
      <p>Queste informazioni saranno visibili solo in caso di emergenza. Mantienile aggiornate.</p>
    </div>

    <!-- #medicalForm="ngForm" dà un nome al form per controllarne lo stato -->
    <form #medicalForm="ngForm" (ngSubmit)="saveMedicalData()">
      
      <!-- Sezione 1: Dati Medici -->
      <fieldset>
        <legend><i class="fas fa-first-aid"></i> Dati Sanitari</legend>
        
        <div class="form-group">
          <label for="bloodType">Gruppo Sanguigno</label>
          <select id="bloodType" name="bloodType" [(ngModel)]="model.bloodType">
            <option [ngValue]="null" disabled>Seleziona il tuo gruppo sanguigno...</option>
            <option value="A+">A+</option> <option value="A-">A-</option>
            <option value="B+">B+</option> <option value="B-">B-</option>
            <option value="AB+">AB+</option> <option value="AB-">AB-</option>
            <option value="0+">0+</option> <option value="0-">0-</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="allergies">Allergie Note</label>
          <textarea id="allergies" name="allergies" [(ngModel)]="model.allergies" rows="3" placeholder="Es. Penicillina, polline, polvere..."></textarea>
        </div>
        
        <div class="form-group">
          <label for="conditions">Patologie Rilevanti</label>
          <textarea id="conditions" name="conditions" [(ngModel)]="model.conditions" rows="3" placeholder="Es. Diabete, ipertensione, asma..."></textarea>
        </div>
        
        <div class="form-group">
          <label for="notes">Note Aggiuntive per i Soccorritori</label>
          <textarea id="notes" name="notes" [(ngModel)]="model.notes" rows="4" placeholder="Qualsiasi altra informazione che ritieni importante (es. porto lenti a contatto, protesi, ecc...)"></textarea>
        </div>
      </fieldset>

      <!-- Sezione 2: Contatti d'Emergenza -->
      <fieldset>
        <legend><i class="fas fa-address-book"></i> Contatti d'Emergenza</legend>
        
        <div *ngFor="let contact of model.emergencyContacts; let i = index" class="contact-row">
          <input type="text" name="contactName_{{i}}" [(ngModel)]="contact.name" placeholder="Nome e Cognome" required>
          
          <!-- ================================================================ -->
          <!-- --- MODIFICA 3: Sostituzione dell'input con il <select> --- -->
          <!-- ================================================================ -->
          <select name="contactRelation_{{i}}" [(ngModel)]="contact.relation" required>
            <option [ngValue]="''" disabled>Relazione...</option>
            <option *ngFor="let type of relationTypes" [value]="type">{{ type }}</option>
          </select>
          
          <input type="tel" name="contactPhone_{{i}}" [(ngModel)]="contact.phone" placeholder="Numero di Telefono" required>
          
          <button type="button" class="btn-remove-contact" (click)="removeContact(i)" title="Rimuovi contatto">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        
        <button type="button" class="btn-add-contact" (click)="addContact()">
          <i class="fas fa-plus"></i> Aggiungi Contatto
        </button>
      </fieldset>

      <!-- Pulsante di Salvataggio -->
      <div class="form-actions">
        <button type="submit" class="btn-save" [disabled]="isSaving || medicalForm.invalid">
          <span *ngIf="!isSaving">Salva le Modifiche</span>
          <span *ngIf="isSaving">Salvataggio in corso...</span>
        </button>
      </div>

    </form>
  </div>
</div>