<div class="form-container">

  @if (isLoading) {
    <div class="loading-indicator">Caricamento dati in corso...</div>
  }

  @if (!isLoading) {
    <div class="form-header">
      <a routerLink="/profile-management" class="back-link"><i class="fas fa-arrow-left"></i> Torna ai Profili</a>
      <h1>Modifica Scheda Medica</h1>
      <p>Queste informazioni saranno visibili solo in caso di emergenza.</p>
    </div>

    <form #medicalForm="ngForm" (ngSubmit)="openConfirmationModal()">
      
      <fieldset>
        <legend><i class="fas fa-user-circle"></i> Dati Anagrafici</legend>
        <div class="form-group">
          <label for="profileName">Nome del Profilo</label>
          <input 
            type="text" 
            id="profileName" 
            name="profileName" 
            [(ngModel)]="model.profileName" 
            placeholder="Es. Profilo Principale, Casco di Sara"
            required
            maxlength="50" >
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Nome</label>
            <input type="text" id="name" name="name" [(ngModel)]="model.name" required maxlength="50"> </div>
          <div class="form-group">
            <label for="surname">Cognome</label>
            <input type="text" id="surname" name="surname" [(ngModel)]="model.surname" required maxlength="50"> </div>
        </div>
        <div class="form-group">
          <label for="birthDate">Data di Nascita</label>
          <input type="date" id="birthDate" name="birthDate" [(ngModel)]="model.birthDate">
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="birthPlace">Luogo di Nascita</label>
            <input type="text" id="birthPlace" name="birthPlace" [(ngModel)]="model.birthPlace" maxlength="100"> </div>
          <div class="form-group">
            <label for="residence">Luogo di Residenza</label>
            <input type="text" id="residence" name="residence" [(ngModel)]="model.residence" maxlength="100"> </div>
        </div>
      </fieldset>
      
      <fieldset>
        <legend><i class="fas fa-first-aid"></i> Dati Sanitari</legend>
        <div class="form-group">
          <label for="bloodType">Gruppo Sanguigno</label>
          <select id="bloodType" name="bloodType" [(ngModel)]="model.bloodType">
            <option [ngValue]="null" disabled>Seleziona il tuo gruppo sanguigno...</option>
            <option value="A+">A+</option> <option value="A-">A-</option>
            <option value="B+">B+</option> <option value="B-">B-</option>
            <option value="AB+">AB+</option> <option value="AB-">AB-</option>
            <option value="0+">0+</option> <option value="0-">0-</option>
          </select>
        </div>
        <div class="form-group">
          <label for="allergies">Allergie Note</label>
          <textarea id="allergies" name="allergies" [(ngModel)]="model.allergies" rows="3" placeholder="Es. Penicillina, polline..." maxlength="500"></textarea> </div>
        <div class="form-group">
          <label for="conditions">Patologie Rilevanti</label>
          <textarea id="conditions" name="conditions" [(ngModel)]="model.conditions" rows="3" placeholder="Es. Diabete, ipertensione..." maxlength="500"></textarea> </div>
        <div class="form-group">
          <label for="notes">Note Aggiuntive per i Soccorritori</label>
          <textarea id="notes" name="notes" [(ngModel)]="model.notes" rows="4" placeholder="Es. Porto lenti a contatto, protesi, ecc..." maxlength="1000"></textarea> </div>
      </fieldset>

      <fieldset>
        <legend><i class="fas fa-address-book"></i> Contatti d'Emergenza</legend>
        <div class="contacts-header">
          <h4>Lista Contatti</h4>
          <p>Hai aggiunto {{ model.emergencyContacts.length }} su un massimo di {{ maxContacts }} contatti.</p>
        </div>
        <div class="contacts-list">
          @if (model.emergencyContacts.length > 0) {
            @for (contact of model.emergencyContacts; track $index) {
              <div class="contact-card">
                <div class="contact-info">
                  <span class="contact-name">{{ contact.name }} ({{ contact.relation }})</span>
                  <span class="contact-phone"><i class="fas fa-phone"></i> {{ contact.phone }}</span>
                </div>
                <div class="contact-actions">
                  <button type="button" class="btn-edit" (click)="openContactModal(contact, $index)">Modifica</button>
                  <button type="button" class="btn-remove" (click)="removeContact($index)">Elimina</button>
                </div>
              </div>
            }
          } @else {
            <p class="no-contacts-message">Nessun contatto di emergenza aggiunto.</p>
          }
        </div>
        <button 
          type="button" 
          class="btn-add-contact" 
          (click)="openContactModal()"
          [disabled]="model.emergencyContacts.length >= maxContacts">
          <i class="fas fa-plus"></i> Aggiungi Contatto
        </button>
      </fieldset>

      <div class="form-actions">
        <button type="submit" class="btn-save" [disabled]="isSaving || medicalForm.invalid">
          Salva le Modifiche
        </button>
      </div>
    </form>
  }

  @if (isConfirmationModalVisible) {
    <div class="modal-backdrop">
      <div class="modal-content">
        <h3>Conferma Dati</h3>
        <p>Stai per salvare informazioni mediche critiche. Ricontrolla attentamente che tutti i dati inseriti siano corretti.</p>
        <label class="confirm-checkbox">
          <input type="checkbox" [(ngModel)]="isDataConfirmed" name="dataConfirmation">
          Dichiaro che le informazioni inserite sono corrette e aggiornate.
        </label>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeConfirmationModal()">Annulla</button>
          <button type="button" class="btn-confirm" (click)="submitSave()" [disabled]="!isDataConfirmed || isSaving">
            {{ isSaving ? 'Salvataggio...' : 'Conferma e Salva' }}
          </button>
        </div>
      </div>
    </div>
  }

  @if (isContactModalVisible) {
    <div class="modal-backdrop">
      <div class="modal-content">
        <h3>{{ isEditMode ? 'Modifica Contatto' : 'Aggiungi Nuovo Contatto' }}</h3>
        <div class="form-group">
          <label for="contactName">Nome e Cognome</label>
          <input type="text" id="contactName" name="contactName" [(ngModel)]="contactModel.name" required maxlength="50"> </div>
        <div class="form-group">
          <label for="contactRelation">Relazione</label>
          <select id="contactRelation" name="contactRelation" [(ngModel)]="contactModel.relation" required>
            <option [ngValue]="''" disabled>Seleziona relazione...</option>
            @for (type of relationTypes; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label for="contactPhone">Numero di Telefono</label>
          <input type="tel" id="contactPhone" name="contactPhone" [(ngModel)]="contactModel.phone" required maxlength="20"> </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeContactModal()">Annulla</button>
          <button type="button" class="btn-confirm" (click)="saveContact()">Salva Contatto</button>
        </div>
      </div>
    </div>
  }

</div>